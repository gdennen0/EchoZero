# EchoZero packaging (PyInstaller)

Production packaging is driven by a single spec and a JSON config so version and identity stay consistent.

## Layout

- **echozero.spec** – PyInstaller spec (entry point, data, hidden imports, macOS bundle).
- **packaging_config.json** – App name, version, bundle identifier, company, and PyInstaller options. Single source for release metadata.
- **scripts/build_app.py** – Wrapper to run `pyinstaller echozero.spec` with optional `--clean`.

## Build (from project root)

Use the same Python environment you use to run EchoZero (venv with `requirements.txt` installed):

```bash
# Activate your venv, then:
pip install pyinstaller   # if not already in requirements
python scripts/build_app.py
# Or: pyinstaller echozero.spec
```

Optional clean build (clear PyInstaller cache first):

```bash
python scripts/build_app.py --clean
```

## Output

- **All platforms**: `dist/EchoZero/` – one-folder bundle. Run `dist/EchoZero/EchoZero` (or `EchoZero.exe` on Windows).
- **macOS**: `dist/EchoZero.app` – app bundle with Info.plist (version, bundle id, copyright). Use this for distribution.

## Config (packaging_config.json)

| Field | Purpose |
|-------|--------|
| app_name | Display name and executable name |
| version | CFBundleShortVersionString / CFBundleVersion on macOS; keep in sync with setup.py for releases |
| bundle_identifier | macOS bundle id (e.g. dev.speedoflight.echozero) |
| company | Used in copyright / plist |
| copyright | NSHumanReadableCopyright in Info.plist |
| bundled_runtime_defaults | Optional. Non-secret defaults embedded in zero-config builds (e.g. MEMBERSTACK_VERIFY_URL). Do not put secrets here. |
| pyinstaller.console | false for GUI |
| pyinstaller.strip | false recommended for debugging |
| pyinstaller.upx | true to compress binaries |

## Shipping a complete package (zero user config)

To ship a build that works with **no user configuration** (like most commercial desktop apps):

1. **Set auth at build time** (once, in CI or on your machine; never commit these):
   ```bash
   MEMBERSTACK_APP_SECRET=your_secret python scripts/build_app.py
   # Optional: MEMBERSTACK_VERIFY_URL=https://echozero-auth.speeoflight.workers.dev
   ```
2. The build script writes `build/bundled_config.env` with those values and the spec bundles it. The app loads it at runtime as the lowest-priority config (user or install-dir `.env` can still override).
3. **Deploy your auth worker** with the same `APP_SECRET` (e.g. `wrangler secret put APP_SECRET`). The worker only accepts requests when the desktop sends that value in `X-App-Token`. So only your shipped app can call your backend.
4. Distribute the resulting `dist/EchoZero.app` or `dist/EchoZero/` folder. End users run the app and log in; no `.env` or env vars required.

This is the standard approach: the secret is embedded at **build time** (one build = one key), and the backend (worker) holds the same secret so only your app can use it. Do not commit `build/bundled_config.env`; it is in `build/` which is gitignored.

**Alternative (open worker):** If you deploy the auth worker **without** setting `APP_SECRET`, the worker skips the `X-App-Token` check and accepts any caller. Then you can build **without** setting `MEMBERSTACK_APP_SECRET` and ship; the app will work but anyone could call your verify endpoint. Use only for development or low-risk cases.

---

## Distribution and environment

### What gets packaged

- **Bundled:** `.env.example` (template). Optional: `bundled_config.env` when you build with `MEMBERSTACK_APP_SECRET` (and optionally `MEMBERSTACK_VERIFY_URL`) set in the environment – that file is created at build time and bundled so the app works with zero user config.
- **Never committed:** `build/bundled_config.env` (gitignored). It is generated by the build script and must not be committed.

### Where the app looks for config (priority: later overrides earlier)

1. **Bundled defaults** – `bundled_config.env` in the bundle (only present if you built with the env vars set).
2. **Install/bundle directory** – `.env` next to the executable (or inside the .app).
3. **User data directory** – `.env` in the platform location (`~/Library/Application Support/EchoZero/.env` on macOS, etc.).
4. **Process environment** – Variables set in the shell or launcher.

For a zero-config ship, (1) is set at build time and (2)–(4) are unused. For developer or IT-configured installs, use (2) or (3) or (4).

### First run

If the user data dir does not have `.env.example`, the app copies the bundled `.env.example` there once. It never overwrites an existing `.env` or `.env.example`.

### Summary

| Item | Packaged? | Purpose |
|------|-----------|--------|
| `.env.example` | Yes | Template; copied to user dir on first run |
| `bundled_config.env` | Yes, only when build env has MEMBERSTACK_APP_SECRET | Zero-config: app works with no user setup |
| `.env` (user/install) | No | Optional overrides; user or IT creates |

### Distributing the app

- **macOS:** Ship `EchoZero.app` (e.g. in a .dmg or zip). Sign and notarize for distribution outside your team.
- **Windows:** Ship the `EchoZero/` folder or an installer. Users run `EchoZero.exe`.
- **Linux:** Ship the `EchoZero/` folder (tarball or AppImage). Users run the `EchoZero` binary.

For zero-config builds, no README is required for auth. For builds without bundled config, tell users to set `MEMBERSTACK_APP_SECRET` (see `.env.example` in Application Support after first run) or use a `.env` file.

## Troubleshooting (macOS)

**App opens then instantly closes (or shows a circle-with-cross icon)**  
The app is crashing on launch. Common causes:

1. **Missing dependencies in the bundle** – Build with a full environment: `pip install -r requirements.txt` then run `python scripts/build_app.py`. The build script warns if `python-dotenv` or `httpx` are missing; the spec bundles them when present.
2. **Run from Terminal to see the error:**  
   `./dist/EchoZero.app/Contents/MacOS/EchoZero`  
   or  
   `open -a dist/EchoZero.app` then check Console.app for "EchoZero" crash logs.

**App icon shows a white circle with a cross**  
That icon usually means either (1) the app crashed on launch (fix the crash first), or (2) no custom icon is set. To set an icon, add `packaging/EchoZero.icns` and rebuild (see `packaging/README.md`).

## Releases

When cutting a release:

1. Bump `version` in `setup.py` and in `packaging_config.json`.
2. Run `python scripts/build_app.py --clean`.
3. Sign and notarize the macOS .app if distributing outside the team (see Apple docs).
4. Distribute `dist/EchoZero.app` (macOS) or `dist/EchoZero/` (Windows/Linux).
